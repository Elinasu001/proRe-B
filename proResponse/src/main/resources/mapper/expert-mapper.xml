<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.even.back.expert.model.mapper.ExpertMapper">

<!-- 전문가 조회 resultMap -->
<resultMap id="expertDetailMap" type="ExpertDetailDTO">
    <id property="expertNo" column="EXPERT_NO"/>

    <result property="profileImg"  column="PROFILE_IMG"/>
    <result property="nickname"    column="NICKNAME"/>
    <result property="career"      column="CAREER"/>
    <result property="startTime"   column="START_TIME"/>
    <result property="endTime"     column="END_TIME"/>
    <result property="starScore"   column="STAR_SCORE"/>
    <result property="reviewCount" column="REVIEW_COUNT"/>
    <result property="address"     column="ADDRESS"/>
    <result property="content"     column="CONTENT"/>
    <result property="userLiked"   column="USER_LIKED"/>
    <result property="completedJobs" column="COMPLETEDJOBS"/>

    <collection property="images" ofType="string">
        <result column="FILE_PATH"/>
    </collection>
</resultMap>
	
	<!-- 전문가 디테일 조회 sql -->
	<select id="getExpertDetails" parameterType="map" resultMap="expertDetailMap">
	SELECT
	       e.USER_NO                 AS EXPERT_NO
	     , m.PROFILE_IMG             AS PROFILE_IMG
	     , m.NICKNAME                AS NICKNAME
	     , e.CAREER                  AS CAREER
	     , e.START_TIME              AS START_TIME
	     , e.END_TIME                AS END_TIME
	     , NVL(es.AVG_STAR_SCORE, 0) AS STAR_SCORE
	     , NVL(es.REVIEW_COUNT, 0)   AS REVIEW_COUNT
	     , m.ADDRESS                 AS ADDRESS
	     , e.CONTENT                 AS CONTENT
	     , ea.FILE_PATH              AS FILE_PATH
	     , CASE
	           WHEN #{userNo} IS NULL THEN 0
	           WHEN EXISTS (
	               SELECT
	                      1
	                 FROM
	                      TB_LIKE ul
	                WHERE
	                      ul.EXPERT_NO = e.USER_NO
	                  AND ul.USER_NO   = #{userNo}
	           ) THEN 1
	           ELSE 0
	       END                       AS USER_LIKED
	     , (
         SELECT COUNT(*)
           FROM TB_ESTIMATE_RESPONSE rp
           JOIN TB_ESTIMATE_REQUEST rq
             ON rp.REQUEST_NO = rq.REQUEST_NO
          WHERE rq.EXPERT_NO = e.USER_NO
            AND rp.STATUS = 'EXPIRED'
       ) AS completedJobs  
	  FROM
	       TB_EXPERT e
	  JOIN
	       TB_MEMBER m
	    ON m.USER_NO = e.USER_NO
	   AND
	       m.STATUS = 'Y'  
	  LEFT
	  JOIN
	       V_EXPERT_STATS es
	    ON es.EXPERT_NO = e.USER_NO
	  LEFT
	  JOIN
	       TB_EXPERTING_ATTACHMENT ea
	    ON ea.USER_NO = e.USER_NO
	 WHERE
	       EXISTS (
	           SELECT
	                  1
	             FROM
	                  TB_EXPERT_SAVE_CATEGORY esc
	            WHERE
	                  esc.USER_NO = e.USER_NO
	       )
	   AND
	       e.USER_NO = #{expertNo}
	</select>	
	<!-- 전문가가 견적 응답 이미지 저장 -->
	<insert id="saveExpertEstimateAttachment">
	INSERT 
	  INTO 
	       TB_ESTIMATE_RESPONSE_ATTACHMENT
    	   (
           FILE_NO
         , ORIGIN_NAME
         , FILE_PATH
         , ESTIMATE_NO 
         , STATUS
           )
    VALUES
           (
     	   SEQ_ESTIMATE_RESPONSE_ATTACHMENT.NEXTVAL
    	 , #{originName}
    	 , #{filePath}
    	 , #{reqNo}  
    	 , 'N'          
    	   )    
	</insert>
	
	<!-- userNo 하고 requestNo로 있는지 검증 -->
	<select id="countByRequestNoAndUserNo" resultType="int">
    SELECT 
           COUNT(*) 
      FROM 
           TB_ESTIMATE_REQUEST 
     WHERE 
           REQUEST_NO = #{requestNo} 
       AND 
           (USER_NO = #{userNo} OR EXPERT_NO = #{userNo})
       AND 
           DELETE_AT = 'N'   
	</select>
	
	<!-- 성사된 견적 수 조회 -->
	<select id="countMatchedByUserNo">
	SELECT 
	       COUNT(*) 
	  FROM 
	       TB_ESTIMATE_RESPONSE rp
 	  LEFT
 	  JOIN 
 	       TB_ESTIMATE_REQUEST rq USING (REQUEST_NO)
 	 WHERE 
 	       rp.STATUS IN ('ACCEPTED' , 'EXPIRED')
 	  AND
 	      EXPERT_NO = #{userNo}
 	  AND
 	      rp.DELETE_AT = 'N'	
	</select>
	
	<!-- 매치된 유저들 조회 -->
	<select id="getMatchedUser" resultType="ExpertRequestUserDTO">
	SELECT
	       rq.REQUEST_NO AS requestNo,
	       m.USER_NO     AS userNo,
	       m.NICKNAME,
	       m.ADDRESS,
	       m.PROFILE_IMG AS profileImg,
	       rp.ESTIMATE_NO  AS estimateNo     
	FROM
	     TB_ESTIMATE_REQUEST rq
	INNER JOIN TB_ESTIMATE_RESPONSE rp
	     ON rq.REQUEST_NO = rp.REQUEST_NO
	INNER JOIN TB_MEMBER m
	     ON m.USER_NO = rq.USER_NO
	    AND m.STATUS = 'Y'
	WHERE
	       rq.EXPERT_NO = #{userNo}
	  AND
	       rq.DELETE_AT = 'N'      
	  AND rp.STATUS IN ('ACCEPTED', 'EXPIRED')     
	ORDER BY
	       rq.REQUEST_NO DESC
	OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>
		
	<select id="getExpertCategories" parameterType="long">
	SELECT 
	       CATEGORY_DETAIL_NO categoryDetailNo
	     , CATEGORY_NAME  categoryName
	  FROM 
	       TB_EXPERT_SAVE_CATEGORY
	  LEFT
	  JOIN
	       TB_EXPERT_DETAIL_CATEGORY USING (CATEGORY_DETAIL_NO)
	  LEFT
	  JOIN
	       TB_EXPERT USING (USER_NO)
	 WHERE
	       USER_NO = #{expertNo}
	 ORDER
	    BY
	       CATEGORY_DETAIL_NO ASC      
	</select>
	
	<select id="getExpertLocations">
	SELECT 
	       USER_NO expertNo
	     , lat latitude
	     , lng longitude
	  FROM 
	       TB_MEMBER m
	  LEFT
	  JOIN 
	       TB_MEMBER_LOCATION USING (USER_NO)
	  LEFT 
	  JOIN 
	       TB_EXPERT e USING (USER_NO)
	 WHERE
	       m.STATUS = 'Y'
	   AND
	       e.STATUS = 'Y'          
	</select>
	
	
	<select id="getLikedExpertsCount">
	SELECT COUNT(*) AS liked_expert_count
	FROM TB_LIKE l
	JOIN TB_EXPERT e
	  ON l.EXPERT_NO = e.USER_NO
	WHERE l.USER_NO = #{userNo}  
	  AND e.STATUS = 'Y'    
	</select>
	
	<select id="getLikedExperts">
	SELECT
	       e.USER_NO                    AS expertNo
	     , m.PROFILE_IMG                AS profileImg
	     , m.NICKNAME                   AS nickName
	     , e.CAREER
	     , e.START_TIME                 AS startTime
	     , e.END_TIME                   AS endTime
	     , NVL(es.AVG_STAR_SCORE, 0)    AS starScore
	     , NVL(es.REVIEW_COUNT, 0)      AS reviewCount
	     , m.ADDRESS
	     , 1                            AS userLiked 
	     , NVL(es.TOTAL_LIKE_COUNT, 0)  AS totalLikes
	     , (SELECT COUNT(*)
	        FROM TB_ESTIMATE_RESPONSE rp2
	        JOIN TB_ESTIMATE_REQUEST rq2
	          ON rp2.REQUEST_NO = rq2.REQUEST_NO
	        WHERE rq2.EXPERT_NO = e.USER_NO
	          AND rp2.STATUS = 'EXPIRED'
	      ) AS completedJobs
	FROM
	       TB_EXPERT e
	JOIN
	       TB_MEMBER m
	  ON m.USER_NO = e.USER_NO
	LEFT JOIN
	       V_EXPERT_STATS es
	  ON es.EXPERT_NO = e.USER_NO
	WHERE
	       EXISTS (
	           SELECT 1
	           FROM TB_LIKE ul
	           WHERE ul.EXPERT_NO = e.USER_NO
	             AND ul.USER_NO   = #{userNo}
	       )
	ORDER BY
	       NVL(es.AVG_STAR_SCORE, 0) DESC
	     , NVL(es.TOTAL_LIKE_COUNT, 0) DESC
	     , e.USER_NO DESC
    OFFSET #{offset} ROWS
	FETCH NEXT #{limit} ROWS ONLY	
	</select>
	
	<!-- requestNo 파일 조회 -->
	<select id="findAllbyRequestNo">
	SELECT	
 	       FILE_PATH
 	  FROM
 	       TB_ESTIMATE_RESPONSE
 	  LEFT
 	  JOIN
 	       TB_ESTIMATE_RESPONSE_ATTACHMENT ra USING (ESTIMATE_NO)
 	 WHERE
 	       REQUEST_NO = #{requestNo}
 	   AND
 	       ra.STATUS = 'N'
 	   AND
 	       DELETE_AT = 'N'
	</select>	
		
    <!-- file들 다 softDelete -->		
	<update id="softDeleteAllAttachments">
	UPDATE TB_ESTIMATE_RESPONSE_ATTACHMENT a
	SET a.STATUS = 'Y'
	WHERE a.ESTIMATE_NO IN (
    SELECT r.ESTIMATE_NO
    FROM TB_ESTIMATE_RESPONSE r
    WHERE r.REQUEST_NO = #{requestNo}
)          
	</update>
	
	<!-- 견적 스테이터스 수정 -->
	<update id="updateStatusByRequestNo">
	UPDATE 
	       TB_ESTIMATE_RESPONSE
	   SET
	       DELETE_AT = 'Y'
	 WHERE 
	       REQUEST_NO = #{requestNo}	
	</update>
	
	<!-- 검색어로 전문가 리스트 수 -->
	<select id="countExpertsByKeyword">
	 SELECT 
            COUNT(*)     
       FROM 
            TB_EXPERT e
       LEFT
       JOIN
            TB_MEMBER m ON e.USER_NO = m.USER_NO
        AND 
            e.STATUS = 'Y'
        AND
            m.STATUS = 'Y'
      WHERE
            m.NICKNAME LIKE '%'|| #{keyword} ||'%'	
	</select>
	
	<!-- 검색어로 전문가 조회 -->
	<select id="getExpertsByNickname">
	SELECT 
	       e.USER_NO AS expertNo
	     , m.PROFILE_IMG AS profileImg  
	     , m.NICKNAME AS nickname
	     , es.REVIEW_COUNT AS reviewCount
	     , es.AVG_STAR_SCORE AS starScore
	     , e.CAREER AS career
	     , es.TOTAL_LIKE_COUNT AS totalLikeCount
	     , (
	         SELECT COUNT(*)
	           FROM TB_ESTIMATE_RESPONSE rp
	           JOIN TB_ESTIMATE_REQUEST rq
	             ON rp.REQUEST_NO = rq.REQUEST_NO
	          WHERE rq.EXPERT_NO = e.USER_NO
	            AND rp.STATUS = 'EXPIRED'
	       ) AS completedJobs
	     , e.CONTENT AS content
	FROM TB_EXPERT e
	JOIN TB_MEMBER m
	  ON e.USER_NO = m.USER_NO
	LEFT JOIN V_EXPERT_STATS es
	  ON es.EXPERT_NO = e.USER_NO
	WHERE e.STATUS = 'Y'
	  AND m.STATUS = 'Y'
	  AND m.NICKNAME LIKE '%' || #{keyword} || '%'
	ORDER BY NVL(es.TOTAL_LIKE_COUNT, 0) DESC
	OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>
	
	<!-- 전문가 등록 카테고리 조회용 ResultMap -->
	<resultMap id="ExpertCategoryTreeMap" type="com.kh.even.back.expert.model.dto.LargeCategoryDTO">
    <!-- 대분류 -->
    <id property="expertTypeNo" column="EXPERT_TYPE_NO"/>
    <result property="expertName" column="EXPERT_NAME"/>

    <!-- 중분류 -->
    <collection property="categories" ofType="com.kh.even.back.expert.model.dto.MiddleCategoryDTO">
        <id property="categoryNo" column="CATEGORY_NO"/>
        <result property="categoryName" column="CATEGORY_NAME"/>

        <!-- 소분류 -->
        <collection property="categories" ofType="com.kh.even.back.expert.model.dto.SmallCategoryDTO">
            <id property="categoryDetailNo" column="CATEGORY_DETAIL_NO"/>
            <result property="categoryDetailName" column="CATEGORY_DETAIL_NAME"/>
        </collection>
        
    </collection>
    
	</resultMap>
	
	<!-- 전문가 등록 카테고리 조회 -->
	<select id="getExpertCategory" resultMap="ExpertCategoryTreeMap">
    SELECT
           T.EXPERT_TYPE_NO,
           T.EXPERT_NAME,
           
           C.CATEGORY_NO,
           C.CATEGORY_NAME,

           D.CATEGORY_DETAIL_NO,
           D.CATEGORY_NAME AS CATEGORY_DETAIL_NAME
      FROM 
           TB_EXPERT_TYPE T
      JOIN 
           TB_EXPERT_CATEGORY C
        ON 
           C.EXPERT_TYPE_NO = T.EXPERT_TYPE_NO
      JOIN 
           TB_EXPERT_DETAIL_CATEGORY D
        ON 
           D.CATEGORY_NO = C.CATEGORY_NO
     ORDER 
        BY
           T.EXPERT_TYPE_NO,
           C.CATEGORY_NO,
           D.CATEGORY_DETAIL_NO
</select>

	<!-- 전문가 등록 -->
	<insert id="insertExpert" parameterType="ExpertRegisterVO">
	INSERT
	  INTO
	       TB_EXPERT
	       (
	       USER_NO
	     , CAREER
	     , START_TIME
	     , END_TIME
	     , CONTENT
	     , EXPERT_TYPE_NO  
	       )
	VALUES (
		   #{userNo}
		 , #{career}
		 , #{startTime}
		 , #{endTime}
		 , #{content}
		 , #{expertTypeNo}  
	       )       
	</insert>
	
	<!-- 전문가 등록 시 소분류 카테고리 저장 -->
	<insert id="insertExpertCategoryDetail">
	INSERT
	  INTO
	       TB_EXPERT_SAVE_CATEGORY
	       (
	       USER_NO
	     , CATEGORY_DETAIL_NO
	       )	
	VALUES
	       (
	       #{userNo}
	     , #{categoryDetailNo}  
	       )       
	</insert>
	
	<!-- 전문가 등록 시 첨부파일 저장 -->
	<insert id="insertExpertAttachment" parameterType="FileVO">
	INSERT
	  INTO
	       TB_EXPERTING_ATTACHMENT
	       (
	       FILE_NO
	     , ORIGIN_NAME
	     , FILE_PATH
	     , UPLOAD_DATE
	     , STATUS
	     , USER_NO
	       )
    VALUES
           (
           SEQ_EXPERTING_ATTACHMENT.NEXTVAL
         , #{originName}
         , #{filePath}
         , SYSDATE
         , 'N'  
         , #{reqNo}  
           )        	
	</insert>
	
	<update id="updateRoleToExpert">
	UPDATE
	       TB_MEMBER
	   SET
	       USER_ROLE = 'ROLE_EXPERT'
	 WHERE
	       USER_NO = #{userNo}          
	</update>
	
	<!-- 새로 등록한 전문가 응답 데이터 조회용 ResultMap -->
	<resultMap id="registerResponseMap" type="com.kh.even.back.expert.model.dto.RegisterResponseDTO">
	  <id property="expert.userNo" column="USER_NO"/>
	  <!-- expert (새로 등록한 전문가의 정보) -->
	  <association property="expert"
	               javaType="com.kh.even.back.expert.model.dto.NewExpertDTO">
	    <id     property="userNo"       column="USER_NO"/>
	    <result property="expertTypeNo" column="EXPERT_TYPE_NO"/>
	    <result property="career"       column="CAREER"/>
	    <result property="startTime"    column="START_TIME"/>
	    <result property="endTime"      column="END_TIME"/>
	    <result property="content"      column="CONTENT"/>
	  </association>
	
	  <!-- List<Long> categories (소분류 카테고리) -->
	  <collection property="categories" ofType="java.lang.Long">
		<result column="CATEGORY_DETAIL_NO"/>
	  </collection>
	
	  <!-- List<AttachmentDTO> attachments (상세 이미지) -->
	  <collection property="attachments" ofType="com.kh.even.back.file.model.dto.AttachmentDTO">
	    <id     property="fileNo"     column="FILE_NO"/>
	    <result property="originName" column="ORIGIN_NAME"/>
	    <result property="filePath"   column="FILE_PATH"/>
	    <result property="uploadDate" column="UPLOAD_DATE"/>
	    <result property="status"     column="FILE_STATUS"/>
	  </collection>
	
	</resultMap>
	
	<!-- 새로 등록한 전문가 응답 데이터 조회 -->
	<select id="getNewExpert" resultMap="registerResponseMap">
 	SELECT
		   E.USER_NO            AS USER_NO
		 , E.EXPERT_TYPE_NO     AS EXPERT_TYPE_NO
		 , E.CAREER             AS CAREER
		 , E.START_TIME         AS START_TIME
		 , E.END_TIME           AS END_TIME
		 , E.CONTENT            AS CONTENT

         , C.CATEGORY_DETAIL_NO AS CATEGORY_DETAIL_NO

	     , A.FILE_NO            AS FILE_NO
	     , A.ORIGIN_NAME        AS ORIGIN_NAME
	     , A.FILE_PATH          AS FILE_PATH
	     , A.UPLOAD_DATE        AS UPLOAD_DATE
	     , A.STATUS             AS FILE_STATUS
	  FROM 
	       TB_EXPERT E
	  LEFT 
	  JOIN 
	       TB_EXPERT_SAVE_CATEGORY C
	    ON 
	       C.USER_NO = E.USER_NO
	  LEFT 
	  JOIN 
	       TB_EXPERTING_ATTACHMENT A
	    ON A.USER_NO = E.USER_NO
	   AND A.STATUS = 'N'
  	 WHERE E.USER_NO = #{userNo}
  	 ORDER 
  	    BY 
  	       E.USER_NO
  	     , C.CATEGORY_DETAIL_NO
  	     , A.FILE_NO
	</select>
	
	<!-- 전문가 수정 폼 조회 (등록 응답과 동일 구조) -->
	<select id="getExpertForEdit" parameterType="long" resultMap="registerResponseMap">
	  SELECT
	         E.USER_NO             AS USER_NO
	       , E.EXPERT_TYPE_NO      AS EXPERT_TYPE_NO
	       , E.CAREER              AS CAREER
	       , E.START_TIME          AS START_TIME
	       , E.END_TIME            AS END_TIME
	       , E.CONTENT             AS CONTENT
	
	       , C.CATEGORY_DETAIL_NO  AS CATEGORY_DETAIL_NO
	
	       , A.FILE_NO             AS FILE_NO
	       , A.ORIGIN_NAME         AS ORIGIN_NAME
	       , A.FILE_PATH           AS FILE_PATH
	       , A.UPLOAD_DATE         AS UPLOAD_DATE
	       , A.STATUS              AS FILE_STATUS
	    FROM 
	         TB_EXPERT E
	    LEFT 
	    JOIN 
	         TB_EXPERT_SAVE_CATEGORY C
	      ON 
	         C.USER_NO = E.USER_NO
	    LEFT 
	    JOIN 
	         TB_EXPERTING_ATTACHMENT A
	      ON 
	         A.USER_NO = E.USER_NO
	     AND 
	         A.STATUS = 'N'
	   WHERE 
	         E.USER_NO = #{userNo}
	   ORDER 
	      BY
	         E.USER_NO
	       , C.CATEGORY_DETAIL_NO
	       , A.FILE_NO
	</select>
	
	
	<!-- 전문가 정보를 수정합니다. -->
	<update id="updateExpert" parameterType="ExpertRegisterDTO">
	UPDATE
	       TB_EXPERT
	   SET
	       USER_NO = #{userNo}
	     , CAREER = #{career}
	     , START_TIME = #{startTime}
	     , END_TIME = #{endTime}
	     , CONTENT = #{content}
	     , EXPERT_TYPE_NO = #{expertTypeNo}
	 WHERE
	       USER_NO = #{userNo}      
	</update>
	
	<!-- DB에 저장된 전문가 소분류 카테고리를 물리적으로 삭제합니다. -->
	<delete id="deleteExpertCategoryDetail" parameterType="long">
	DELETE
	       TB_EXPERT_SAVE_CATEGORY  
	 WHERE
	       USER_NO = #{userNo}
	</delete>
	
	<!-- 전문가의 활성화 중인 상세이미지 개수 -->
	<select id="countActiveAttachments" parameterType="long" resultType="int">
  	SELECT 
  	       COUNT(*)
      FROM 
           TB_EXPERTING_ATTACHMENT
   	 WHERE 
   	       USER_NO = #{userNo}
       AND 
           STATUS = 'N'
	</select>
	
	<!-- 전문가의 삭제될 상세이미지 개수 -->
	<select id="countDeletableAttachments" resultType="int">
  	SELECT
  	       COUNT(*)
      FROM 
           TB_EXPERTING_ATTACHMENT
     WHERE
           USER_NO = #{userNo}
       AND
           STATUS = 'N'
       AND 
           FILE_NO IN
     <foreach collection="deleteFileNos" item="id" open="(" close=")" separator=",">
       #{id}
     </foreach>
	</select>
	
	<!-- 전문가 상세이미지 삭제 처리 ((삭제여부)STATUS = 'Y' 논리삭제) -->
	<update id="deleteExpertAttachments">
    UPDATE 
           TB_EXPERTING_ATTACHMENT
       SET 
           STATUS = 'Y'
     WHERE
           USER_NO = #{userNo}
       AND 
           STATUS = 'N'
       AND 
           FILE_NO IN
	  <foreach collection="deleteFileNos" item="id" open="(" close=")" separator=",">
	    #{id}
	  </foreach>
	</update>
	
	                     
</mapper>