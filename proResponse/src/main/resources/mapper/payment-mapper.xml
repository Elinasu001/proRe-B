<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.even.back.payment.model.mapper.PaymentMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="paymentResultMap" type="PaymentVO">
        <id property="paymentNo" column="PAYMENT_NO"/>
        <result property="amount" column="AMOUNT"/>
        <result property="status" column="STATUS"/>
        <result property="merchantUid" column="MERCHANT_UID"/>
        <result property="impUid" column="IMP_UID"/>
        <result property="createDate" column="CREATE_DATE"/>
        <result property="roomNo" column="ROOM_NO"/>
        <result property="estimateNo" column="ESTIMATE_NO"/>
    </resultMap>

    <!-- 결제 준비 정보 저장 (READY) -->
    <insert id="insertPreparePayment" parameterType="PaymentPrepareRequest">
        <selectKey keyProperty="paymentNo" resultType="long" order="BEFORE">
            SELECT SEQ_PAYMENT.NEXTVAL FROM DUAL
        </selectKey>
        INSERT 
          INTO 
               TB_PAYMENT 
               (
                 PAYMENT_NO
               , AMOUNT
               , STATUS
               , MERCHANT_UID
               , CREATE_DATE
               , ROOM_NO
               , ESTIMATE_NO
               ) 
               VALUES 
               (
                 #{paymentNo}
               , #{amount}
               , 'READY'
               , #{merchantUid}
               , SYSDATE
               , #{roomNo}
               , #{estimateNo}
               )
    </insert>

    <!-- merchant_uid로 결제 정보 조회 -->
    <select id="selectPaymentByMerchantUid" parameterType="PaymentVerifyRequest" resultMap="paymentResultMap">
        SELECT 
               P.PAYMENT_NO
             , P.AMOUNT
             , P.STATUS
             , P.MERCHANT_UID
             , P.IMP_UID
             , P.CREATE_DATE
             , P.ROOM_NO
             , CR.ESTIMATE_NO
          FROM 
               TB_PAYMENT P
          JOIN 
               TB_CHAT_ROOM CR 
            ON 
               P.ROOM_NO = CR.ROOM_NO
         WHERE 
               P.MERCHANT_UID = #{merchantUid}
           AND 
               CR.STATUS = 'Y'
    </select>

    <!-- imp_uid로 결제 정보 조회 -->
    <select id="selectPaymentByImpUid" parameterType="PaymentCancelRequest" resultMap="paymentResultMap">
        SELECT 
               P.PAYMENT_NO
             , P.AMOUNT
             , P.STATUS
             , P.MERCHANT_UID
             , P.IMP_UID
             , P.CREATE_DATE
             , P.ROOM_NO
             , CR.ESTIMATE_NO
          FROM 
               TB_PAYMENT P
          JOIN 
               TB_CHAT_ROOM CR 
            ON 
               P.ROOM_NO = CR.ROOM_NO
         WHERE 
               P.IMP_UID = #{impUid}
           AND 
               CR.STATUS = 'Y'
    </select>

    <!-- 결제 완료 상태 업데이트 (READY → PAID) -->
    <update id="updatePaymentStatus" parameterType="PaymentVerifyRequest">
        UPDATE 
               TB_PAYMENT
           SET 
               IMP_UID = #{impUid}
             , STATUS = #{status}
         WHERE 
               MERCHANT_UID = #{merchantUid}
    </update>

    <!-- 결제 취소 상태 업데이트 (PAID → FAILED) -->
    <update id="updateCancelStatus" parameterType="PaymentCancelRequest">
        UPDATE 
               TB_PAYMENT
           SET 
               STATUS = #{status}
         WHERE 
               IMP_UID = #{impUid}
    </update>

    <!-- 결제 상세 조회 -->
    <select id="selectPaymentDetail" parameterType="PaymentDetailRequest" resultMap="paymentResultMap">
        SELECT 
               P.PAYMENT_NO
             , P.AMOUNT
             , P.STATUS
             , P.MERCHANT_UID
             , P.IMP_UID
             , P.CREATE_DATE
             , P.ROOM_NO
             , CR.ESTIMATE_NO
          FROM 
               TB_PAYMENT P
          JOIN 
               TB_CHAT_ROOM CR 
            ON 
               P.ROOM_NO = CR.ROOM_NO
         WHERE 
               P.IMP_UID = #{impUid}
           AND 
               CR.STATUS = 'Y'
    </select>

    <!-- estimateNo로 결제 정보 조회 -->
    <select id="getByEstimateNo" parameterType="Long" resultMap="paymentResultMap">
        SELECT 
               P.PAYMENT_NO
             , P.ROOM_NO
             , P.AMOUNT
             , P.STATUS
             , P.MERCHANT_UID
             , P.IMP_UID
             , P.CREATE_DATE
             , CR.ESTIMATE_NO
          FROM 
               TB_PAYMENT P
          JOIN 
               TB_CHAT_ROOM CR 
            ON 
               P.ROOM_NO = CR.ROOM_NO
         WHERE 
               CR.ESTIMATE_NO = #{estimateNo}
           AND 
               CR.STATUS = 'Y'
    </select>

    <!-- roomNo로 결제 정보 조회 -->
    <select id="getByRoomNo" parameterType="Long" resultMap="paymentResultMap">
        SELECT 
               P.PAYMENT_NO
             , P.ROOM_NO
             , P.AMOUNT
             , P.STATUS
             , P.MERCHANT_UID
             , P.IMP_UID
             , P.CREATE_DATE
             , CR.ESTIMATE_NO
          FROM 
               TB_PAYMENT P
          JOIN 
               TB_CHAT_ROOM CR 
            ON 
               P.ROOM_NO = CR.ROOM_NO
         WHERE 
               P.ROOM_NO = #{roomNo}
           AND 
               CR.STATUS = 'Y'
    </select>

</mapper>