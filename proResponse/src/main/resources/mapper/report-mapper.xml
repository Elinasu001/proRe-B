<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.kh.even.back.report.model.dao.ReportMapper">


	<!-- 신고 상세 ResultMap -->
	<resultMap id="reportDetailResultMap" type="ReportDetailDTO">
		<id property="reportNo" column="REPORT_NO"/>
		<result property="content" column="CONTENT"/>
		<result property="createDate" column="CREATE_DATE"/>
		<result property="updateDate" column="UPDATE_DATE"/>
		<result property="status" column="STATUS"/>
		<result property="reasonNo" column="REASON_NO"/>
		<result property="reporterUserNo" column="REPORTER_USER_NO"/>
		<result property="targetUserNo" column="TARGET_USER_NO"/>
		<result property="estimateNo" column="ESTIMATE_NO"/>

		<collection property="selectedTags"
			ofType="ReportTagDTO"
			select="getTagsByReportNo"
			column="REPORT_NO"/>
	</resultMap>


	<!-- 태그 ResultMap -->
	<resultMap id="reportTagResultMap" type="ReportTagDTO">
		<id property="reasonNo" column="REASON_NO"/>
		<result property="reasonName" column="REASON_NAME"/>
		<result property="selected" column="SELECTED"/>
	</resultMap>


	<!-- 신고 상세 조회(상세)-->
	<select id="getByEstimateNo" parameterType="Long" resultMap="reportDetailResultMap">
		SELECT
			   r.REPORT_NO
			 , r.CONTENT
			 , r.CREATE_DATE
			 , r.UPDATE_DATE
			 , r.STATUS
			 , r.REASON_NO
			 , r.ESTIMATE_NO
			 , r.REPORTER_USER_NO
			 , r.TARGET_USER_NO
		  FROM 
		       TB_REPORT r
		 WHERE 
		       r.ESTIMATE_NO = #{estimateNo}
		   AND 
		       r.STATUS = 'WAITING'
	</select>

	<!-- 태그 목록 조회(상세) -->
	<select id="getTagsByReportNo" parameterType="Long" resultMap="reportTagResultMap">
	  SELECT
			 t.REASON_NO
		   , t.REASON_NAME
		   , 1 AS SELECTED
		FROM 
			 TB_REPORT r
		JOIN 
			 TB_REPORT_TAG t ON r.REASON_NO = t.REASON_NO
	   WHERE 
			 r.REPORT_NO = #{reportNo}
	</select>


	<!-- 태그 전체 조회 -->
	<select id="getAllReportTags" resultMap="reportTagResultMap">
		SELECT
			   REASON_NO
			 , REASON_NAME
			 , 0 AS SELECTED
		  FROM 
		       TB_REPORT_TAG
		 ORDER 
		    BY 
			   REASON_NO
	</select>

	<!-- 신고 중복 체크 -->
    <select id="existsReportByEstimateNo"
        parameterType="Long"
        resultType="boolean">
      SELECT
        CASE
             WHEN COUNT(*) &gt; 0 THEN 1 <!--신고가 존재하면 1(true)-->
             ELSE 0 <!--신고가 존재 안하면 2(false)-->
         END
        FROM TB_REPORT
       WHERE ESTIMATE_NO = #{value}
    </select>

	<!-- 신고 등록 -->
	<insert id="saveReport" parameterType="ReportVO">
		<selectKey keyProperty="reportNo" resultType="long" order="BEFORE">
			SELECT SEQ_REPORT.NEXTVAL FROM DUAL
		</selectKey>
		INSERT 
		  INTO 
		       TB_REPORT
			   (
		 	   REPORT_NO
			 , CONTENT
			 , CREATE_DATE
			 , STATUS
			 , REASON_NO
			 , ESTIMATE_NO
			 , REPORTER_USER_NO
			 , TARGET_USER_NO
			   ) 
		VALUES
			   (
			   #{reportNo}
			 , #{content}
			 , SYSDATE
			 , 'WAITING'
			 , #{reasonNo}
			 , #{estimateNo}
			 , #{reporterUserNo}
			 , #{targetUserNo}
			)
	</insert>

</mapper>