<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.kh.even.back.report.model.dao.ReportMapper">

	<!-- 신고 상세 ResultMap -->
	<resultMap id="reportDetailResultMap" type="ReportDetailDTO">
		<id property="reportNo" column="REPORT_NO"/>
		<result property="content" column="CONTENT"/>
		<result property="createDate" column="CREATE_DATE"/>
		<result property="reportUserNo" column="REPORT_USER_NO"/>
		<result property="targetUserNo" column="TARGET_USER_NO"/>
		<result property="estimateNo" column="ESTIMATE_NO"/>

		<collection property="selectedTags"
			ofType="ReportTagDTO"
			select="getTagsByReportNo"
			column="REPORT_NO"/>
	</resultMap>


	<!-- 태그 ResultMap -->
	<resultMap id="reportTagResultMap" type="ReportTagDTO">
		<id property="tagNo" column="TAG_NO"/>
		<result property="tagName" column="TAG_NAME"/>
		<result property="selected" column="SELECTED"/>
	</resultMap>


	<!-- 신고 상세 조회(상세)-->
	<select id="getByEstimateNo" parameterType="Long" resultMap="reportDetailResultMap">
	   SELECT
			  r.REPORT_NO
			, r.CONTENT
			, r.CREATE_DATE
			, r.REPORT_USER_NO
			, r.TARGET_USER_NO
			, r.ESTIMATE_NO
		 FROM 
			  TB_REPORT r
		WHERE 
			  r.ESTIMATE_NO = #{estimateNo}
		  AND 
			  r.STATUS = 'WAITING'
	</select>

	<!-- 태그 목록 조회(상세) -->
	<select id="getTagsByReportNo" parameterType="Long" resultMap="reportTagResultMap">
	   SELECT
			  t.REASON_NO
			, t.REASON_NAME
			, rt.SELECTED
		 FROM 
			  TB_REPORT_TAG t
		 LEFT 
		 JOIN 
			  TB_REPORT_TAG_MAPPING rt
		   ON 
			  t.REASON_NO = rt.REASON_NO
	    WHERE 
			  rt.REPORT_NO = #{reportNo}
	</select>


	<!-- 태그 전체 조회 -->
    <select id="getAllReportTags" resultMap="reportTagResultMap">
         SELECT
                REASON_NO
              , REASON_NAME
              , 1 AS SELECTED
           FROM 
                TB_REPORT_TAG
          ORDER 
             BY REASON_NO
    </select>

</mapper>